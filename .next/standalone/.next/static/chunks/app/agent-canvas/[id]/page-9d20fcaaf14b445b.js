(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[843],{18552:(e,t,a)=>{Promise.resolve().then(a.bind(a,94433))},94433:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>G});var l=a(95155),o=a(12115),n=a(75484),s=a(95368),i=a(68719),r=a(76962);a(11687);var d=a(34004),c=a(30495),u=a(61040),g=a(73583),f=a(69367),p=a(13538),h=a(48699),x=a(70822),v=a(39732),m=a(8937),A=a(58691),j=a(28715),y=a(49067),b=a(93060),C=a(28690),w=a(95321),k=a(36913),S=a(80290),I=a(52834),D=a(96347),N=a(94714),F=a(76046),E=a(2921),O=a(63809),T=a(95071),H=a(50077),R=a(39534),z=a(71500),W=a(71921);let _={custom:O.A},B={buttonedge:T.A};function P(){let e=(0,F.useRouter)(),t=(0,F.useParams)().id,a=(0,o.useRef)(null),[O,T]=(0,o.useState)(null),[P,G,J]=(0,n.ck)([]),[L,q,M]=(0,n.fM)([]),[U,V]=(0,o.useState)(null),[K,X]=(0,o.useState)(!1),[Y,Q]=(0,o.useState)(!1),[Z,$]=(0,o.useState)(!1),[ee,et]=(0,o.useState)([]),[ea,el]=(0,o.useState)(null),[eo,en]=(0,o.useState)(!0),[es,ei]=(0,o.useState)(!1),[er,ed]=(0,o.useState)(""),[ec,eu]=(0,o.useState)(""),[eg,ef]=(0,o.useState)(""),[ep,eh]=(0,o.useState)(!0),[ex,ev]=(0,o.useState)({open:!1,message:"",severity:"info"});(0,o.useEffect)(()=>{let e=async()=>{en(!0);try{let a=await fetch("/api/owlagents?id=".concat(t));if(a.ok){var e;let t=await a.json();el(t),ed(t.name),eu(t.description),ef((null===(e=t.tags)||void 0===e?void 0:e.join(", "))||"");let l=t.flow.nodes.map(e=>({id:e.id,type:"custom",position:e.position,data:{label:e.data.label,type:e.data.type,category:e.data.category,config:e.data.config||{},humanReview:e.data.humanReview,agentId:e.data.agentId,agentName:e.data.agentName,onConfigure:e=>{var t;return null===(t=em.current)||void 0===t?void 0:t.call(em,e)},onDelete:e=>{var t;return null===(t=eA.current)||void 0===t?void 0:t.call(eA,e)}}}));G(l),q(t.flow.edges||[])}let l=await fetch("/api/owlagents");if(l.ok){let e=await l.json();et(e.filter(e=>e.id!==t).map(e=>({id:e.id,name:e.name,description:e.description})))}}catch(e){console.error("Failed to load agent:",e),ev({open:!0,message:"エージェントの読み込みに失敗しました",severity:"error"})}finally{en(!1)}};t&&e()},[t,G,q]);let em=(0,o.useRef)();em.current=e=>{let t=P.find(t=>t.id===e);t&&(V(t),X(!0))};let eA=(0,o.useRef)();eA.current=e=>{G(t=>t.filter(t=>t.id!==e)),q(t=>t.filter(t=>t.source!==e&&t.target!==e)),(null==U?void 0:U.id)===e&&(V(null),X(!1))};let ej=(0,o.useCallback)(e=>{var t;null===(t=em.current)||void 0===t||t.call(em,e)},[]),ey=(0,o.useCallback)(e=>{var t;null===(t=eA.current)||void 0===t||t.call(eA,e)},[]),eb=(0,o.useCallback)(e=>{q(t=>(0,n.rN)({...e,type:"smoothstep",animated:!0},t))},[q]),eC=(0,o.useCallback)(e=>{e.preventDefault();let t=e.dataTransfer.getData("application/reactflow");if(!t||!O||!a.current)return;let l=JSON.parse(t),o=O.screenToFlowPosition({x:e.clientX,y:e.clientY}),n={id:"".concat(l.type,"-").concat(Date.now()),type:"custom",position:o,data:{label:l.label,type:l.type,category:l.category,config:{},agentId:l.agentId,agentName:l.agentId?l.label:void 0,onConfigure:ej,onDelete:ey}};G(e=>[...e,n])},[O,G,ej,ey]),ew=(0,o.useCallback)(e=>{e.preventDefault(),e.dataTransfer.dropEffect="move"},[]),ek=(0,o.useCallback)((e,t)=>{V(t),X(!0)},[]),eS=(0,o.useCallback)((e,t,a)=>{G(l=>l.map(l=>l.id===e?{...l,data:{...l.data,config:t,humanReview:a}}:l)),V(l=>(null==l?void 0:l.id)===e?{...l,data:{...l.data,config:t,humanReview:a}}:l)},[G]),eI=(0,o.useCallback)(async()=>{if(ea){ei(!0);try{let e;ep&&(e=(0,W.f2)(P,L));let t=await fetch("/api/owlagents",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({...ea,name:er.trim(),description:ec.trim(),tags:eg.split(",").map(e=>e.trim()).filter(e=>e),flow:{nodes:P.map(e=>({id:e.id,type:e.data.type,position:e.position,data:{label:e.data.label,type:e.data.type,category:e.data.category,config:e.data.config,humanReview:e.data.humanReview,agentId:e.data.agentId,agentName:e.data.agentName}})),edges:L.map(e=>({id:e.id,source:e.source,target:e.target,sourceHandle:e.sourceHandle,targetHandle:e.targetHandle}))},syncToFlowise:ep,flowiseFlowData:e})});if(t.ok){let e=await t.json();el(e);let a="エージェントを保存しました";e.flowiseChatflowId&&(a+=" (Flowise: ".concat(e.flowiseChatflowId,")")),ev({open:!0,message:a,severity:"success"})}else throw Error("Save failed")}catch(e){ev({open:!0,message:"保存に失敗しました",severity:"error"})}finally{ei(!1)}}},[ea,er,ec,eg,P,L,ep]);return eo?(0,l.jsx)(d.A,{sx:{display:"flex",justifyContent:"center",alignItems:"center",height:"100vh",bgcolor:"#0f0f1a"},children:(0,l.jsx)(c.A,{sx:{color:"#6366f1"}})}):ea?(0,l.jsxs)(d.A,{sx:{display:"flex",flexDirection:"column",height:"100vh",bgcolor:"#0f0f1a"},children:[(0,l.jsxs)(f.A,{sx:{borderRadius:0,bgcolor:"#16213e",borderBottom:"2px solid #0f3460",px:2,py:1,display:"flex",alignItems:"center",justifyContent:"space-between"},children:[(0,l.jsxs)(d.A,{sx:{display:"flex",alignItems:"center",gap:2},children:[(0,l.jsx)(p.A,{onClick:()=>e.push("/agent-canvas"),sx:{color:"#90CAF9"},children:(0,l.jsx)(D.A,{})}),(0,l.jsxs)(h.A,{variant:"h6",sx:{fontWeight:700,color:"#e94560",display:"flex",alignItems:"center",gap:1},children:[(0,l.jsx)("span",{style:{fontSize:"1.3rem"},children:"\uD83E\uDD89"}),er||"Untitled Agent"]}),(0,l.jsx)(x.A,{label:"v".concat(ea.version),size:"small",sx:{bgcolor:"#4CAF50",color:"#fff"}}),(0,l.jsx)(x.A,{label:"".concat(P.length," nodes"),size:"small",variant:"outlined",sx:{color:"#90CAF9",borderColor:"#90CAF9"}})]}),(0,l.jsxs)(d.A,{sx:{display:"flex",alignItems:"center",gap:1},children:[(0,l.jsx)(v.A,{title:"Settings",children:(0,l.jsx)(p.A,{onClick:()=>$(!0),sx:{color:"#90CAF9"},children:(0,l.jsx)(N.A,{})})}),(0,l.jsx)(g.A,{variant:"outlined",startIcon:(0,l.jsx)(I.A,{}),onClick:()=>Q(!0),sx:{color:"#4CAF50",borderColor:"#4CAF50","&:hover":{borderColor:"#66BB6A",bgcolor:"rgba(76, 175, 80, 0.1)"}},children:"Test"}),(0,l.jsx)(g.A,{variant:"contained",startIcon:es?(0,l.jsx)(c.A,{size:20,color:"inherit"}):(0,l.jsx)(S.A,{}),onClick:eI,disabled:es,sx:{bgcolor:"#6366f1","&:hover":{bgcolor:"#5558e3"}},children:es?"Saving...":"Save"})]})]}),(0,l.jsxs)(d.A,{sx:{display:"flex",flex:1,overflow:"hidden"},children:[(0,l.jsx)(E.A,{savedOwlAgents:ee}),(0,l.jsxs)(d.A,{ref:a,sx:{flex:1,position:"relative"},children:[(0,l.jsxs)(n.Gc,{nodes:P,edges:L,onNodesChange:J,onEdgesChange:M,onConnect:eb,onInit:T,onDrop:eC,onDragOver:ew,onNodeDoubleClick:ek,nodeTypes:_,edgeTypes:B,fitView:!0,snapToGrid:!0,snapGrid:[15,15],defaultEdgeOptions:{type:"smoothstep",animated:!0,style:{stroke:"#6366f1",strokeWidth:2}},style:{background:"#0f0f1a"},children:[(0,l.jsx)(s.H,{}),(0,l.jsx)(i.o,{style:{backgroundColor:"#1e1e2f"},nodeColor:e=>{var t;let a=(0,z.KF)(null===(t=e.data)||void 0===t?void 0:t.type);return(null==a?void 0:a.color)||"#607D8B"}}),(0,l.jsx)(r.V,{color:"#2d2d44",gap:20,size:1})]}),0===P.length&&(0,l.jsx)(d.A,{sx:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",textAlign:"center",pointerEvents:"none"},children:(0,l.jsx)(h.A,{sx:{color:"#666",fontSize:"1.2rem",mb:1},children:"Drag nodes from the palette to build your flow"})})]}),K&&U&&(0,l.jsx)(H.A,{nodeId:U.id,nodeData:U.data,onClose:()=>X(!1),onSave:eS,savedOwlAgents:ee},"config-".concat(U.id,"-").concat(JSON.stringify(U.data.config||{})))]}),(0,l.jsxs)(m.A,{open:Z,onClose:()=>$(!1),maxWidth:"sm",fullWidth:!0,children:[(0,l.jsx)(A.A,{children:"Agent Settings"}),(0,l.jsx)(j.A,{children:(0,l.jsxs)(d.A,{sx:{pt:1},children:[(0,l.jsx)(y.A,{fullWidth:!0,label:"Agent Name",value:er,onChange:e=>ed(e.target.value),sx:{mb:2},required:!0}),(0,l.jsx)(y.A,{fullWidth:!0,label:"Description",value:ec,onChange:e=>eu(e.target.value),multiline:!0,rows:3,sx:{mb:2},required:!0}),(0,l.jsx)(y.A,{fullWidth:!0,label:"Tags (comma separated)",value:eg,onChange:e=>ef(e.target.value),placeholder:"e.g., AI, chatbot, support",sx:{mb:2}}),(0,l.jsx)(b.A,{control:(0,l.jsx)(C.A,{checked:ep,onChange:e=>eh(e.target.checked),color:"primary"}),label:"Flowiseに同期",sx:{display:"block"}}),(0,l.jsx)(h.A,{variant:"caption",color:"text.secondary",children:"有効にすると、保存時にFlowiseのChatflowとして登録/更新されます"}),(null==ea?void 0:ea.flowiseChatflowId)&&(0,l.jsxs)(h.A,{variant:"caption",color:"success.main",sx:{display:"block",mt:1},children:["現在のChatflow ID: ",ea.flowiseChatflowId]})]})}),(0,l.jsx)(w.A,{children:(0,l.jsx)(g.A,{onClick:()=>$(!1),children:"Close"})})]}),(0,l.jsx)(R.A,{open:Y,onClose:()=>Q(!1),nodes:P,edges:L}),(0,l.jsx)(k.A,{open:ex.open,autoHideDuration:4e3,onClose:()=>ev(e=>({...e,open:!1})),anchorOrigin:{vertical:"bottom",horizontal:"right"},children:(0,l.jsx)(u.A,{onClose:()=>ev(e=>({...e,open:!1})),severity:ex.severity,sx:{width:"100%"},children:ex.message})})]}):(0,l.jsxs)(d.A,{sx:{p:4,bgcolor:"#0f0f1a",minHeight:"100vh"},children:[(0,l.jsx)(u.A,{severity:"error",children:"エージェントが見つかりません"}),(0,l.jsx)(g.A,{variant:"outlined",startIcon:(0,l.jsx)(D.A,{}),onClick:()=>e.push("/agent-canvas"),sx:{mt:2},children:"戻る"})]})}function G(){return(0,l.jsx)(n.Ln,{children:(0,l.jsx)(P,{})})}},96347:(e,t,a)=>{"use strict";a.d(t,{A:()=>n});var l=a(20389),o=a(95155);let n=(0,l.A)((0,o.jsx)("path",{d:"M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20z"}),"ArrowBack")}},e=>{var t=t=>e(e.s=t);e.O(0,[294,702,708,96,783,539,971,769,734,916,441,517,358],()=>t(18552)),_N_E=e.O()}]);