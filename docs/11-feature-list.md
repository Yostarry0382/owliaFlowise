# OwliaFabrica 機能一覧

## 概要

OwliaFabricaの機能一覧です。**Flowise**をバックエンドの実行エンジンとして使用し、**統一フクロウキャンバス**でエージェントの作成からマルチエージェント構成まで一貫して管理できます。

- **利用者**: エージェントを使って業務を効率化する一般社員
- **作成者**: エージェントを設計・構築する開発者・パワーユーザー

---

## 用語定義

| 用語 | 定義 |
|------|------|
| **フクロウ（OwlAgent）** | 複数ノードで構成されたエージェント単位。1つの役割・機能を持つ |
| **ノード** | フクロウ内部の処理単位（LLM、RAG、Memory等）。抽象ノードとして定義し、設定パネルで具体的な実装（OpenAI、Pinecone等）を選択 |
| **フクロウキャンバス** | フクロウの作成・編集・接続を統一管理する画面 |
| **マルチフクロウ** | 複数のフクロウを連携させたワークフロー |

```
┌──────────────────────────────────────────────────────────────┐
│                   フクロウキャンバス（統一）                   │
│                                                              │
│  ┌─────────────────┐      ┌─────────────────┐              │
│  │   🦉 フクロウA   │      │   🦉 フクロウB   │              │
│  │  (FAQ応答)      │ ───→ │  (要約)         │              │
│  │ ┌───┬───┬───┐ │      │ ┌───┬───┐     │              │
│  │ │LLM│RAG│Out│ │      │ │LLM│Out│     │              │
│  │ └───┴───┴───┘ │      │ └───┴───┘     │              │
│  └─────────────────┘      └─────────────────┘              │
│                                                              │
│  ※ フクロウをダブルクリック → 内部ノード編集モードへ          │
│  ※ フクロウ間をドラッグ → マルチフクロウ接続                  │
└──────────────────────────────────────────────────────────────┘
```

---

## 1. エージェント作成者向け機能

### 1.1 エージェント基本設定

| # | 機能 | 概要 | 優先度 | MVP |
|---|------|------|--------|-----|
| C-1 | 基本情報入力 | フクロウの名前・一行説明・詳細説明 | 高 | ✅ |
| C-2 | 対象ユーザー設定 | 自分/チーム/部署/全社 | 高 | ✅ |
| C-3 | タグ設定 | カテゴリタグの選択・追加 | 高 | ✅ |
| C-4 | アイコン設定 | フクロウのアイコン選択 | 低 | - |

### 1.2 テンプレート機能

| # | 機能 | 概要 | 優先度 | MVP |
|---|------|------|--------|-----|
| C-5 | フクロウテンプレート一覧 | FAQ応答/資料作成/調査等の用途別テンプレート表示 | 高 | ✅ |
| C-6 | テンプレートから作成 | テンプレートを選んでフクロウ作成開始 | 高 | ✅ |
| C-7 | テンプレートプレビュー | 内部ノード構成を事前確認 | 中 | - |

### 1.3 統一フクロウキャンバス

1つのキャンバスで「フクロウ作成（内部ノード編集）」と「マルチフクロウ構成」を統一管理。

#### キャンバス基本操作

| # | 機能 | 概要 | 優先度 | MVP |
|---|------|------|--------|-----|
| C-8 | フクロウキャンバス表示 | フクロウの配置・接続を管理する統一キャンバス | 高 | ✅ |
| C-9 | フクロウ新規作成 | キャンバス上に新しいフクロウを配置 | 高 | ✅ |
| C-10 | 既存フクロウ配置 | 保存済みフクロウをキャンバスに配置（再利用） | 高 | ✅ |
| C-11 | フクロウ間接続 | フクロウ同士をエッジで接続（マルチフクロウ構成） | 高 | ✅ |
| C-12 | キャンバス保存 | キャンバス全体（マルチフクロウ構成）を保存 | 高 | ✅ |
| C-13 | キャンバス読み込み | 保存済みキャンバスを編集再開 | 高 | ✅ |

#### フクロウ内部編集（ノード編集モード）

| # | 機能 | 概要 | 優先度 | MVP |
|---|------|------|--------|-----|
| C-14 | 内部編集モード切替 | フクロウをダブルクリックで内部ノード編集モードへ | 高 | ✅ |
| C-15 | ノード追加 | サイドバーから抽象ノード（LLM/RAG/Memory等）を追加 | 高 | ✅ |
| C-16 | ノード間接続 | ノード同士をエッジで接続してフロー構築 | 高 | ✅ |
| C-17 | ノード設定パネル | 実装選択（OpenAI/Anthropic等）とパラメータ設定 | 高 | ✅ |
| C-18 | フクロウ保存 | 編集中のフクロウをFlowise Chatflow形式で保存 | 高 | ✅ |
| C-19 | 編集モード終了 | 内部編集を終了してキャンバス全体表示に戻る | 高 | ✅ |

#### 抽象ノードと実装選択（MVP）

フクロウ内部で使用できる抽象ノード。各ノードは設定パネルで具体的な実装を選択する。

| 抽象ノード | アイコン | 役割 | MVP対応実装 |
|-----------|---------|------|-------------|
| LLMノード | 💬 | 言語モデル処理 | OpenAI (GPT-4)、Anthropic (Claude) |
| RAGノード | 📚 | ナレッジベース検索 | Pinecone、Chroma |
| メモリノード | 🧠 | 会話履歴の保持 | Buffer Memory |
| 出力ノード | 📤 | 最終応答の出力 | 標準出力 |
| ツールノード | 🔧 | 外部API/ツール呼び出し | Web検索 (Serper)、Calculator |
| 入力ノード | 📥 | ユーザー入力の受け取り | 標準入力 |
| 条件分岐ノード | 🔀 | IF/ELSE分岐 | If-Else |

※ Phase 2以降、Flowiseの便利なノード（Gmail連携、Google Sheets、コード実行等）を順次追加予定

#### 設定パネルの構成

```
┌─────────────────────────────────────────┐
│ LLMノード 設定                          │
├─────────────────────────────────────────┤
│ 実装を選択:                             │
│   ○ OpenAI (GPT-4)                     │
│   ● Anthropic (Claude)                 │
├─────────────────────────────────────────┤
│ パラメータ:                             │
│   モデル: [claude-3-5-sonnet ▼]        │
│   Temperature: [0.7        ]           │
│   Max Tokens:  [2048       ]           │
└─────────────────────────────────────────┘
```

#### 人間チェック（Human-in-the-Loop）

| # | 機能 | 概要 | 優先度 | MVP |
|---|------|------|--------|-----|
| C-20 | 人間チェック設定 | ノードまたはフクロウ単位で人間確認ON/OFF設定 | 高 | ✅ |
| C-21 | チェックポイント表示 | 確認が必要な箇所を視覚的にハイライト | 高 | ✅ |
| C-22 | 確認メッセージ設定 | 確認時に表示するメッセージを設定 | 中 | - |
| C-23 | 自動承認タイムアウト | 指定時間後に自動承認する設定 | 低 | - |

#### テンプレート機能

| # | 機能 | 概要 | 優先度 | MVP |
|---|------|------|--------|-----|
| C-24 | ノードテンプレート一覧 | LLM/RAG/Memory等の標準ノードを表示 | 高 | ✅ |
| C-25 | ノードテンプレート挿入 | テンプレからワンクリック追加 | 高 | ✅ |
| C-26 | ツールノードテンプレート一覧 | Web検索/Calculator等のツールノード表示 | 高 | ✅ |
| C-27 | ツールノードテンプレート挿入 | テンプレからワンクリック追加 | 高 | ✅ |
| C-28 | プロンプトテンプレート | よく使うシステムプロンプトを選択・挿入 | 高 | ✅ |
| C-29 | カスタムテンプレート保存 | 自作ノード構成/フクロウをテンプレ保存 | 中 | - |
| C-30 | カスタムテンプレート共有 | チーム/全社にテンプレを共有 | 低 | - |

### 1.4 標準テンプレート（MVP想定）

#### フクロウテンプレート（エージェント単位）

| テンプレート名 | 内容 | 内部ノード構成 |
|---------------|------|---------------|
| FAQ応答フクロウ | 社内FAQ向けエージェント | 入力→LLM→RAG→出力 |
| 資料要約フクロウ | ドキュメント要約エージェント | 入力→LLM→出力 |
| コードレビューフクロウ | コードレビューエージェント | 入力→LLM→出力 |
| 調査フクロウ | Web検索+回答生成 | 入力→ツール(検索)→LLM→出力 |

#### ノードテンプレート（フクロウ内部用）

| テンプレート名 | 抽象ノード | デフォルト実装 |
|---------------|-----------|---------------|
| LLMノード（GPT-4） | LLMノード | OpenAI GPT-4 |
| LLMノード（Claude） | LLMノード | Anthropic Claude |
| RAGノード（Pinecone） | RAGノード | Pinecone |
| RAGノード（Chroma） | RAGノード | Chroma |
| メモリノード | メモリノード | Buffer Memory |

#### ツールノードテンプレート

| テンプレート名 | デフォルト実装 |
|---------------|---------------|
| Web検索ノード | Serper |
| 計算ノード | Calculator |

#### プロンプトテンプレート

| テンプレート名 | 内容 |
|---------------|------|
| FAQ応答 | 社内FAQ向けシステムプロンプト |
| 資料要約 | ドキュメント要約向けプロンプト |
| コードレビュー | コードレビュー向けプロンプト |

### 1.5 RAG連携機能

| # | 機能 | 概要 | 優先度 | MVP |
|---|------|------|--------|-----|
| C-31 | RAG一覧表示 | Flowise/Portal経由で利用可能なRAGを表示 | 高 | ✅ |
| C-32 | RAG選択・紐づけ | RAGノードにRAGコレクションを紐づけ | 高 | ✅ |
| C-33 | RAG新規作成 | Fabricaから新規RAG作成 | 中 | - |
| C-34 | RAGファイルアップロード | 資料をアップロードしてRAG化 | 中 | - |

※ RAG管理の詳細設定はOwlia-Portal経由で行います。

### 1.6 テスト機能

| # | 機能 | 概要 | 優先度 | MVP |
|---|------|------|--------|-----|
| C-35 | テスト実行 | 作成中のフクロウをFlowise経由でテスト | 高 | ✅ |
| C-36 | テスト結果表示 | 回答内容・RAGヒット状況を表示 | 高 | ✅ |
| C-37 | マルチフクロウテスト | フクロウ間連携を含めた統合テスト | 高 | ✅ |
| C-38 | テストシナリオ登録 | 想定Q&Aを登録 | 中 | - |
| C-39 | 一括テスト実行 | 登録シナリオをまとめて実行 | 中 | - |
| C-40 | テストシナリオ自動生成 | フローから想定Q&Aを自動生成 | 低 | - |

### 1.7 公開・管理機能

| # | 機能 | 概要 | 優先度 | MVP |
|---|------|------|--------|-----|
| C-41 | 公開範囲設定 | 自分/チーム/部署/全社 | 高 | ✅ |
| C-42 | 公開実行 | フクロウ/マルチフクロウ構成を公開状態にする | 高 | ✅ |
| C-43 | 非公開化 | 公開済みを非公開に | 中 | - |
| C-44 | 削除 | フクロウを削除 | 中 | - |
| C-45 | 複製 | 既存フクロウをコピーして編集 | 中 | - |

---

## 2. エージェント利用者向け機能

### 2.1 カタログ機能

| # | 機能 | 概要 | 優先度 | MVP |
|---|------|------|--------|-----|
| C-46 | フクロウ一覧表示 | 公開済みフクロウをカード/リスト形式で表示 | 高 | ✅ |
| C-47 | 検索 | キーワードでフクロウ名・説明を検索 | 高 | ✅ |
| C-48 | タグフィルタ | カテゴリタグで絞り込み | 高 | ✅ |
| C-49 | 部門フィルタ | 作成部門・対象部門で絞り込み | 中 | - |
| C-50 | 用途フィルタ | FAQ/資料作成/調査等の用途で絞り込み | 中 | - |
| C-51 | ソート | 人気順/新着順/名前順 | 中 | - |
| C-52 | フクロウ詳細表示 | 説明・能力値・使用例・作成者情報 | 高 | ✅ |

### 2.2 マイフクロウ機能

| # | 機能 | 概要 | 優先度 | MVP |
|---|------|------|--------|-----|
| C-53 | お気に入り登録 | よく使うフクロウをお気に入りに追加 | 中 | - |
| C-54 | お気に入り一覧 | 自分のお気に入りフクロウを表示 | 中 | - |
| C-55 | 利用履歴 | 最近使ったフクロウを表示 | 低 | - |

### 2.3 チャット実行機能（Flowise経由）

| # | 機能 | 概要 | 優先度 | MVP |
|---|------|------|--------|-----|
| C-56 | チャット画面 | フクロウ（Flowise Chatflow）と会話できるUI | 高 | ✅ |
| C-57 | 会話履歴表示 | 現在のセッションの履歴を表示 | 高 | ✅ |
| C-58 | ストリーミング応答 | Flowise Prediction APIのストリーミング対応 | 高 | ✅ |
| C-59 | ファイルアップロード | Flowiseへのファイル送信 | 中 | - |
| C-60 | 会話リセット | 新しい会話を開始 | 中 | - |
| C-61 | 会話履歴保存 | 過去の会話を保存・再表示 | 低 | - |

### 2.4 フィードバック機能

| # | 機能 | 概要 | 優先度 | MVP |
|---|------|------|--------|-----|
| C-62 | 評価ボタン | 回答に対して👍/👎を送信 | 中 | - |
| C-63 | コメント送信 | 評価と一緒にコメントを送信 | 低 | - |

### 2.5 外部システム連携API

| # | 機能 | 概要 | 優先度 | MVP |
|---|------|------|--------|-----|
| C-64 | フクロウ情報API | Portal/Spriteがフクロウ一覧を取得 | 高 | ✅ |
| C-65 | フクロウ実行API | Portal/SpriteからFlowise経由でフクロウ実行 | 高 | ✅ |
| C-66 | Flowise接続状態API | Flowiseサーバーの稼働確認 | 高 | ✅ |

---

## 3. MVPスコープまとめ

### 3.1 作成者向け機能（MVP: 27機能）

| 区分 | 機能# | 機能名 |
|------|-------|--------|
| 基本設定 | C-1〜C-3 | 基本情報・対象ユーザー・タグ |
| テンプレート | C-5, C-6 | フクロウテンプレート一覧・作成 |
| キャンバス基本 | C-8〜C-13 | キャンバス表示・フクロウ配置・接続・保存 |
| 内部編集 | C-14〜C-19 | ノード編集モード・ノード操作 |
| 人間チェック | C-20, C-21 | 設定・表示 |
| テンプレート再利用 | C-24〜C-28 | ノード/ツール/プロンプト |
| RAG連携 | C-31, C-32 | 一覧・紐づけ |
| テスト | C-35〜C-37 | 単体・統合テスト |
| 公開 | C-41, C-42 | 範囲設定・公開 |

### 3.2 利用者向け機能（MVP: 10機能）

| 区分 | 機能# | 機能名 |
|------|-------|--------|
| カタログ | C-46〜C-48, C-52 | 一覧・検索・フィルタ・詳細 |
| チャット | C-56〜C-58 | 画面・履歴・ストリーミング |
| API | C-64〜C-66 | 情報・実行・接続状態 |

### 3.3 MVPで含めない機能

| 区分 | 機能# | 理由 |
|------|-------|------|
| 基本設定 | C-4 | アイコン設定は優先度低 |
| テンプレート | C-7 | 作成後に確認可能 |
| 人間チェック | C-22, C-23 | 基本機能で十分 |
| カスタムテンプレート | C-29, C-30 | Phase 2以降 |
| RAG作成 | C-33, C-34 | Portal経由で代替 |
| テストシナリオ | C-38〜C-40 | 手動テストで代替 |
| 管理機能 | C-43〜C-45 | Phase 2以降 |
| 部門/用途フィルタ | C-49〜C-51 | 初期はフクロウ数が少ない |
| マイフクロウ | C-53〜C-55 | 認証なしのため実装困難 |
| ファイル/履歴 | C-59〜C-61 | Phase 2以降 |
| フィードバック | C-62, C-63 | Phase 2以降 |

---

## 4. アーキテクチャ

### 4.1 統一フクロウキャンバスの構造

```
┌──────────────────────────────────────────────────────────────┐
│                   統一フクロウキャンバス                       │
│                                                              │
│  【キャンバスレベル】フクロウの配置・接続                      │
│  ┌─────────────────┐      ┌─────────────────┐              │
│  │   🦉 フクロウA   │      │   🦉 フクロウB   │              │
│  │  (FAQ応答)      │ ───→ │  (要約)         │              │
│  └─────────────────┘      └─────────────────┘              │
│                                                              │
│  【内部編集モード】フクロウ内のノード編集                      │
│  ┌─────────────────────────────────────────┐              │
│  │   🦉 フクロウA 内部                       │              │
│  │  ┌────┐   ┌────┐   ┌────┐   ┌────┐  │              │
│  │  │入力│ → │LLM │ → │RAG │ → │出力│  │              │
│  │  └────┘   └────┘   └────┘   └────┘  │              │
│  │             ↓設定パネル                  │              │
│  │        [OpenAI ▼] [Temperature: 0.7]   │              │
│  └─────────────────────────────────────────┘              │
└──────────────────────────────────────────────────────────────┘
```

### 4.2 抽象ノード → Flowise変換

```
┌─────────────────────────────────────────────────────────────┐
│                   OwliaFabrica                              │
│                                                             │
│  【抽象ノード】           【設定パネル】                      │
│  ┌─────────────┐        ┌─────────────────────┐           │
│  │ LLMノード 💬│  ────→ │ 実装: Anthropic ▼   │           │
│  └─────────────┘        │ モデル: Claude 3.5   │           │
│                          │ Temperature: 0.7    │           │
│                          └─────────────────────┘           │
└─────────────────────────────┬───────────────────────────────┘
                              │ FlowiseAdapter変換
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                   Flowise flowData                          │
│  {                                                          │
│    "nodes": [{                                              │
│      "data": {                                              │
│        "name": "ChatAnthropic",                             │
│        "inputParams": [                                     │
│          {"name": "modelName", "value": "claude-3-5-sonnet"}│
│          {"name": "temperature", "value": 0.7}              │
│        ]                                                    │
│      }                                                      │
│    }]                                                       │
│  }                                                          │
└─────────────────────────────────────────────────────────────┘
```

### 4.3 データ構造

```typescript
// 抽象ノード定義
interface AbstractNode {
  id: string;
  type: 'llm' | 'rag' | 'memory' | 'output' | 'tool' | 'input' | 'condition';
  implementation: string;  // 'openai', 'anthropic', 'pinecone' 等
  params: Record<string, any>;  // 実装固有のパラメータ
  position: { x: number; y: number };
}

// フクロウ（OwlAgent）= 複数ノードの集合体
interface OwlAgent {
  id: string;
  name: string;
  description: string;
  nodes: AbstractNode[];  // 抽象ノード構成
  edges: Edge[];          // ノード間の接続
  flowiseChatflowId?: string;  // Flowise同期時のID
}

// マルチフクロウキャンバス = 複数フクロウの配置・接続
interface OwlCanvas {
  id: string;
  name: string;
  owlAgents: OwlAgentRef[];  // 配置されたフクロウ参照
  connections: Connection[];  // フクロウ間の接続
}
```

### 4.4 Flowise連携フロー

```
┌─────────────────────────────────────────────────────────────┐
│               OwliaFabrica フロントエンド                    │
│                                                             │
│  ┌───────────────────────────────────────────────────────┐ │
│  │              統一フクロウキャンバス                      │ │
│  │  🦉 ←→ 🦉 ←→ 🦉  （抽象ノードで編集）                │ │
│  └──────────────────────┬────────────────────────────────┘ │
│                         │                                   │
│  ┌──────────────────────▼────────────────────────────────┐ │
│  │            FlowiseAdapter                              │ │
│  │  - convertOwlAgentToFlowise()  // 抽象→Flowise形式   │ │
│  │  - convertFlowiseToOwlAgent()  // Flowise→抽象形式   │ │
│  │  - convertCanvasToFlowise()    // マルチ構成変換       │ │
│  └──────────────────────┬────────────────────────────────┘ │
│                         │                                   │
│  ┌──────────────────────▼────────────────────────────────┐ │
│  │            FlowiseClient                               │ │
│  │  - createChatflow() / updateChatflow()                │ │
│  │  - predict() / predictStream()                        │ │
│  └──────────────────────┬────────────────────────────────┘ │
└─────────────────────────┼───────────────────────────────────┘
                          │ HTTP/REST
                          ▼
┌─────────────────────────────────────────────────────────────┐
│                      Flowise                                │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │  Chatflows  │  │  Prediction │  │  Document   │        │
│  │    API      │  │    API      │  │   Store     │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
└─────────────────────────────────────────────────────────────┘
```

### 4.5 主要APIエンドポイント

| エンドポイント | 用途 |
|---------------|------|
| `GET /api/flowise/status` | 接続状態確認 |
| `GET /api/flowise/chatflows` | Chatflow一覧取得 |
| `POST /api/flowise/chatflows` | Chatflow作成 |
| `POST /api/owlagents` | フクロウ作成（Flowise同期オプション） |
| `POST /api/flowise/chat` | チャット実行（Prediction API経由） |
| `GET /api/owlcanvas` | キャンバス一覧取得（新規） |
| `POST /api/owlcanvas` | キャンバス保存（新規） |

---

## 5. 実装上の注意点

### 5.1 統一キャンバスの操作モード

| モード | 操作 | 対象 |
|--------|------|------|
| **キャンバスモード** | フクロウの配置・接続・削除 | フクロウ単位 |
| **内部編集モード** | ノードの追加・接続・設定 | ノード単位 |

モード切替:
- キャンバスモード → 内部編集モード: フクロウをダブルクリック
- 内部編集モード → キャンバスモード: 「戻る」ボタン or ESCキー

### 5.2 MVP対応実装一覧

| 抽象ノード | MVP対応実装 | Phase 2以降追加予定 |
|-----------|-------------|-------------------|
| LLMノード | OpenAI, Anthropic | Ollama, Bedrock, Google AI |
| RAGノード | Pinecone, Chroma | Supabase, Qdrant, Milvus |
| メモリノード | Buffer Memory | Zep Memory, Redis Memory |
| ツールノード | Serper, Calculator | Gmail, Google Sheets, コード実行 |
| 入力ノード | 標準入力 | - |
| 出力ノード | 標準出力 | - |
| 条件分岐ノード | If-Else | - |

### 5.3 フクロウの制約（MVP）

| 項目 | 制約 | 対応方針 |
|------|------|---------|
| 抽象ノードタイプ | 7種類 | Phase 2以降で追加 |
| 実装選択肢 | 主要なもののみ | Phase 2以降でFlowiseノード追加 |
| マルチフクロウ | 順次実行のみ | 並列実行はPhase 2以降 |

### 5.4 Flowise依存

- **Flowiseサーバー**: 必須の外部依存（`FLOWISE_API_URL`で接続）
- **バージョン**: Flowise APIの互換性に注意
- **RAG管理**: Owlia-Portal経由

### 5.5 認証について

- **MVPでは認証なし**: お気に入り・履歴等のユーザー紐づけ機能はMVP対象外
- **Phase 2以降**: SSO連携を検討

---

## 6. Phase 2以降のロードマップ

### 6.1 ノード実装の拡充

Phase 2以降、Flowiseの便利なノードを順次追加予定：

| カテゴリ | 追加予定ノード |
|---------|---------------|
| **LLM** | Ollama（ローカル）、Bedrock（AWS）、Google AI |
| **RAG** | Supabase、Qdrant、Milvus |
| **Memory** | Zep Memory、Redis Memory |
| **ツール** | Gmail連携、Google Sheets、Google Calendar |
| **ツール** | コード実行（Python/JS）、ファイル読み書き |
| **ツール** | Custom API（汎用REST） |

### 6.2 機能拡張

- カスタムテンプレート（保存・共有）
- テストシナリオ機能
- マルチフクロウの並列実行
- 認証・ユーザー管理

---

## 7. 備考

### チャット実行環境

- **メイン環境**: Owlia-Portal / Owlia-Sprite
- **Fabrica内チャット**: 作成後すぐに試すための簡易版

### 既存実装の活用

- React Flowベースのキャンバス: 実装済み（統一キャンバス化が必要）
- FlowiseClient: 実装済み
- OwlAgent管理API: 実装済み
- FlowiseAdapter: **未実装（新規開発必要）**
- OwlCanvas API: **未実装（新規開発必要）**
- ノード実装メタデータ: **未実装（新規開発必要）**

---

## 8. 外部システム連携アーキテクチャ

### 8.1 概要

OwliaFabricaで作成したフクロウ（OwlAgent）は、以下のシステムから利用されます：

| システム | 技術スタック | 用途 |
|---------|-------------|------|
| **Owlia-Portal** | Next.js + Python | Web UIからフクロウを利用 |
| **Owlia-Sprite** | C# | デスクトップアプリからフクロウを利用 |

### 8.2 アーキテクチャ図

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           外部システム連携全体像                              │
│                                                                             │
│  ┌──────────────┐    ┌──────────────┐                                      │
│  │ Owlia-Sprite │    │ Owlia-Portal │                                      │
│  │    (C#)      │    │ (Next.js)    │                                      │
│  └──────┬───────┘    └──────┬───────┘                                      │
│         │                   │                                               │
│         │  REST API         │  REST API                                     │
│         │  + API Key認証    │  + API Key認証                                │
│         │                   │                                               │
│         ▼                   ▼                                               │
│  ┌─────────────────────────────────────────────────────────────────┐       │
│  │                    OwliaFabrica BFF                              │       │
│  │                     (Next.js API)                                │       │
│  │  ┌───────────────────────────────────────────────────────────┐  │       │
│  │  │ /api/chat         → チャット実行                           │  │       │
│  │  │ /api/owlagents    → フクロウ一覧取得                       │  │       │
│  │  │ /api/flowise/*    → Flowise操作                           │  │       │
│  │  └───────────────────────────────────────────────────────────┘  │       │
│  └──────────────────────────┬──────────────────────────────────────┘       │
│                              │                                              │
│                              │ Flowise API                                  │
│                              ▼                                              │
│  ┌─────────────────────────────────────────────────────────────────┐       │
│  │                        Flowise                                   │       │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │       │
│  │  │  Prediction │  │  Chatflows  │  │  Document   │             │       │
│  │  │    API      │  │    API      │  │   Store     │             │       │
│  │  └──────┬──────┘  └─────────────┘  └─────────────┘             │       │
│  └─────────┼───────────────────────────────────────────────────────┘       │
│            │                                                                │
│            │ ★ ツール実行（MVP: Custom Tool方式）                           │
│            ▼                                                                │
│  ┌─────────────────────────────────────────────────────────────────┐       │
│  │                    FastAPI (Python)                              │       │
│  │  - 社内システムAPI                                               │       │
│  │  - データベースアクセス                                          │       │
│  │  - ファイル操作                                                  │       │
│  │  - 外部SaaS連携                                                  │       │
│  └─────────────────────────────────────────────────────────────────┘       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 8.3 ツール連携方式

#### MVP: B方式（Custom Tool → REST API）

Flowiseの **Custom Tool** ノードを使用し、FastAPIで実装されたREST APIを呼び出します。

```
【B方式：Custom Tool → REST API】

┌───────────────┐      ┌───────────────┐      ┌───────────────┐
│   Flowise     │      │   FastAPI     │      │  社内システム  │
│  Custom Tool  │ ───→ │  REST API     │ ───→ │  (既存)       │
│               │ HTTP │               │      │               │
└───────────────┘      └───────────────┘      └───────────────┘

メリット:
- Flowise標準機能で実現可能
- FastAPIでAPIを自由に設計
- 既存システムとの連携が容易

デメリット:
- ツールごとにAPIエンドポイントが必要
- Flowise側でCustom Tool設定が必要
```

#### Phase 2以降: C方式（MCP連携）※必要があれば要件等

FlowiseがMCP（Model Context Protocol）をサポートした場合、MCPサーバー経由でツールを提供します。

```
【C方式：MCP連携（Phase 2以降）】

┌───────────────┐      ┌───────────────┐      ┌───────────────┐
│   Flowise     │      │   MCP Server  │      │  社内システム  │
│  MCP Client   │ ───→ │  (Python)     │ ───→ │  (既存)       │
│               │ MCP  │               │      │               │
└───────────────┘      └───────────────┘      └───────────────┘

メリット:
- 標準プロトコルで統一
- ツールの動的検出
- Claude等他のLLMと共通化

デメリット:
- Flowiseのサポート待ち
- MCPサーバー開発が必要
```

### 8.4 MVP実装チェックリスト

#### Fabrica側（Next.js）

| 項目 | 内容 | 状態 |
|------|------|------|
| `/api/chat` | チャットエンドポイント | **新規実装** |
| `/api/owlagents` | フクロウ一覧API | 実装済み |
| `/api/flowise/chatflows` | Chatflow管理API | 実装済み |
| API Key認証 | ヘッダー`X-API-Key`で認証 | **新規実装** |

#### Flowise側

| 項目 | 内容 | 状態 |
|------|------|------|
| Chatflow作成 | フクロウごとにChatflow登録 | FlowiseAdapter経由 |
| Custom Tool設定 | FastAPI呼び出し用ツール | **新規設定** |
| ストリーミング対応 | Prediction APIのストリーム | サポート済み |

#### FastAPI側（Python）

| 項目 | 内容 | 状態 |
|------|------|------|
| ツールエンドポイント | 社内システム連携API | **新規実装** |
| OpenAPI仕様 | Custom Tool用スキーマ | **新規実装** |
| 認証 | API Key認証 | **新規実装** |

#### Portal側（Next.js + Python）

| 項目 | 内容 | 状態 |
|------|------|------|
| Fabricaクライアント | REST API呼び出し | **新規実装** |
| チャットUI | Fabrica経由でフクロウと会話 | **新規実装** |
| フクロウ一覧 | 利用可能フクロウの表示 | **新規実装** |

#### Sprite側（C#）

| 項目 | 内容 | 状態 |
|------|------|------|
| FabricaChatClient | REST API呼び出しクラス | **新規実装** |
| ストリーミング対応 | Server-Sent Events処理 | **新規実装** |
| セッション管理 | 会話継続のためのsessionId管理 | **新規実装** |

### 8.5 Sprite (C#) 実装例

```csharp
using System.Net.Http;
using System.Net.Http.Json;
using System.Text.Json;

namespace OwliaSprite.Services
{
    /// <summary>
    /// Fabrica APIクライアント
    /// フクロウ（OwlAgent）とのチャット機能を提供
    /// </summary>
    public class FabricaChatClient
    {
        private readonly HttpClient _httpClient;
        private readonly string _apiKey;
        private readonly string _baseUrl;

        public FabricaChatClient(string baseUrl, string apiKey)
        {
            _baseUrl = baseUrl.TrimEnd('/');
            _apiKey = apiKey;
            _httpClient = new HttpClient();
            _httpClient.DefaultRequestHeaders.Add("X-API-Key", _apiKey);
        }

        /// <summary>
        /// フクロウにメッセージを送信
        /// </summary>
        public async Task<ChatResponse> SendMessageAsync(
            string chatflowId,
            string message,
            string? sessionId = null)
        {
            var request = new
            {
                chatflowId,
                message,
                sessionId
            };

            var response = await _httpClient.PostAsJsonAsync(
                $"{_baseUrl}/api/chat",
                request
            );

            response.EnsureSuccessStatusCode();
            return await response.Content.ReadFromJsonAsync<ChatResponse>()
                ?? throw new Exception("Failed to parse response");
        }

        /// <summary>
        /// ストリーミング形式でメッセージを送信
        /// </summary>
        public async IAsyncEnumerable<string> SendMessageStreamAsync(
            string chatflowId,
            string message,
            string? sessionId = null)
        {
            var request = new
            {
                chatflowId,
                message,
                sessionId,
                streaming = true
            };

            var httpRequest = new HttpRequestMessage(HttpMethod.Post, $"{_baseUrl}/api/chat")
            {
                Content = JsonContent.Create(request)
            };

            var response = await _httpClient.SendAsync(
                httpRequest,
                HttpCompletionOption.ResponseHeadersRead
            );

            response.EnsureSuccessStatusCode();

            using var stream = await response.Content.ReadAsStreamAsync();
            using var reader = new StreamReader(stream);

            while (!reader.EndOfStream)
            {
                var line = await reader.ReadLineAsync();
                if (!string.IsNullOrEmpty(line))
                {
                    yield return line;
                }
            }
        }

        /// <summary>
        /// 利用可能なフクロウ一覧を取得
        /// </summary>
        public async Task<List<OwlAgent>> GetOwlAgentsAsync()
        {
            var response = await _httpClient.GetAsync($"{_baseUrl}/api/owlagents");
            response.EnsureSuccessStatusCode();
            return await response.Content.ReadFromJsonAsync<List<OwlAgent>>()
                ?? new List<OwlAgent>();
        }
    }

    // レスポンス型
    public record ChatResponse(
        string Text,
        string? SessionId,
        bool Success
    );

    public record OwlAgent(
        string Id,
        string Name,
        string Description,
        string? FlowiseChatflowId
    );
}
```

### 8.6 認証方式

#### MVP: API Key認証

| 項目 | 内容 |
|------|------|
| 認証ヘッダー | `X-API-Key: {api_key}` |
| キー管理 | 環境変数 `FABRICA_API_KEY` |
| ユーザー識別 | なし（MVPでは不要） |

```typescript
// Fabrica API側の認証ミドルウェア例
export function validateApiKey(request: NextRequest) {
  const apiKey = request.headers.get('X-API-Key');
  const validKey = process.env.FABRICA_API_KEY;

  if (!apiKey || apiKey !== validKey) {
    return NextResponse.json(
      { error: 'Unauthorized' },
      { status: 401 }
    );
  }
  return null; // 認証OK
}
```

#### Phase 2以降: ユーザー認証

- SSO連携（社内認証基盤）
- JWT トークン認証
- ユーザーごとの権限管理

### 8.7 B → C 移行パス

| フェーズ | 方式 | 内容 |
|---------|------|------|
| MVP | B方式 | Custom Tool + FastAPI |
| 移行期 | B + C併用 | 既存はCustom Tool、新規はMCP |
| Phase 2以降 | C方式 | MCP統一（Flowiseサポート後）|

移行時の注意点:
1. FastAPI側のエンドポイントはMCPサーバーに移植
2. Flowise側のCustom ToolをMCP Clientに置き換え
3. 移行期間中は両方式の共存が必要
