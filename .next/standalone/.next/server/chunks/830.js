exports.id=830,exports.ids=[830],exports.modules={96487:()=>{},78335:()=>{},50658:(e,t,s)=>{"use strict";s.d(t,{i:()=>l,w:()=>i});let o={async execute(e,t,s){let o=e.data.config||{},n=o.template||o.systemMessage||"";return Object.entries(t).forEach(([e,t])=>{let s=RegExp(`\\{${e}\\}`,"g");n=n.replace(s,String(t))}),n=n.replace(/\{input\}/g,String(s.input)),s.logs.push(`[PromptTemplate] ${e.data.label}: テンプレート適用`),{success:!0,output:n}}},n={async execute(e,t,s){let o=e.data.config||{},n=o.systemMessage||"",a=o.temperature||.7,u=t.input||t.prompt||s.input;s.logs.push(`[LLM] ${e.data.label}: API呼び出し開始`);let r=process.env.AZURE_OPENAI_API_KEY,l=process.env.AZURE_OPENAI_ENDPOINT,i=process.env.AZURE_OPENAI_DEPLOYMENT_NAME,c=process.env.AZURE_OPENAI_API_VERSION||"2024-02-15-preview",p=process.env.OPENAI_API_KEY;if(r&&l&&i)try{let t=`${l}/openai/deployments/${i}/chat/completions?api-version=${c}`;s.logs.push(`[LLM] Azure OpenAI使用: ${i}`);let o=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json","api-key":r},body:JSON.stringify({messages:[...n?[{role:"system",content:n}]:[],{role:"user",content:String(u)}],temperature:a})});if(!o.ok){let e=await o.text();throw Error(`Azure OpenAI API error: ${o.status} - ${e}`)}let p=await o.json(),g=p.choices?.[0]?.message?.content||"";return s.logs.push(`[LLM] ${e.data.label}: Azure OpenAI応答取得成功`),{success:!0,output:g}}catch(t){s.logs.push(`[LLM] ${e.data.label}: Azure OpenAI呼び出し失敗 - ${t instanceof Error?t.message:"Unknown error"}`)}if(p&&p.startsWith("sk-"))try{s.logs.push(`[LLM] 通常のOpenAI API使用`);let t=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${p}`},body:JSON.stringify({model:o.modelName||"gpt-3.5-turbo",messages:[...n?[{role:"system",content:n}]:[],{role:"user",content:String(u)}],temperature:a})});if(!t.ok)throw Error(`OpenAI API error: ${t.status}`);let r=await t.json(),l=r.choices?.[0]?.message?.content||"";return s.logs.push(`[LLM] ${e.data.label}: OpenAI応答取得成功`),{success:!0,output:l}}catch(t){s.logs.push(`[LLM] ${e.data.label}: OpenAI呼び出し失敗 - モック応答を返します`)}r||p?p&&!p.startsWith("sk-")&&s.logs.push(`[LLM] 警告: Azure OpenAIをご利用の場合は、AZURE_OPENAI_ENDPOINT と AZURE_OPENAI_DEPLOYMENT_NAME も設定してください。`):s.logs.push(`[LLM] 警告: APIキーが設定されていません。.env.localを確認してください。`);let g=`[モック応答] システム: "${n.slice(0,50)}..." への応答です。入力: "${String(u).slice(0,50)}..."`;return s.logs.push(`[LLM] ${e.data.label}: モック応答`),{success:!0,output:g}}},a={async execute(e,t,s){let o=e.data.config||{},n=t.input||s.input;return s.logs.push(`[VectorStore] ${e.data.label}: 検索実行 (provider: ${o.provider}, index: ${o.indexName})`),{success:!0,output:[{content:`関連ドキュメント1: ${String(n).slice(0,30)}...に関する情報`,score:.95},{content:`関連ドキュメント2: 補足情報`,score:.87},{content:`関連ドキュメント3: 追加コンテキスト`,score:.82}].slice(0,o.topK||3)}}},u={execute:async(e,t,s)=>(s.logs.push(`[${e.data.type}] ${e.data.label}: パススルー`),{success:!0,output:t.input||t})},r={start:{execute:async(e,t,s)=>(s.logs.push(`[Start] ${e.data.label}: 入力受付`),{success:!0,output:s.input})},end:{async execute(e,t,s){let o=t.input||t;return s.logs.push(`[End] ${e.data.label}: 出力完了`),{success:!0,output:o}}},condition:{async execute(e,t,s){let o=e.data.config||{},n=t.input,a=o.condition||"true",u=!1;try{if(a.includes("==")){let[e,t]=a.split("==").map(e=>e.trim());u=String(n)===t.replace(/['"]/g,"")}else if(a.includes("includes")){let e=a.match(/includes\(['"](.+)['"]\)/);e&&(u=String(n).includes(e[1]))}else u=!!n}catch{u=!!n}return s.logs.push(`[Condition] ${e.data.label}: ${u?"true":"false"}`),{success:!0,output:{result:u,value:n}}}},forEach:{async execute(e,t,s){let o=t.array||t.input||[];return Array.isArray(o)?(s.logs.push(`[ForEach] ${e.data.label}: ${o.length} 件処理`),{success:!0,output:{items:o,complete:!0}}):(s.logs.push(`[ForEach] ${e.data.label}: 配列ではありません`),{success:!0,output:{items:[o],complete:!0}})}},humanReview:{async execute(e,t,s){let o=e.data.config||{},n=e.data.humanReview||{};return!1!==o.enabled&&!1!==n.enabled?(s.logs.push(`[HumanReview] ${e.data.label}: 確認待機中`),s.pendingReview={nodeId:e.id,output:t.input,message:o.message||n.approvalMessage||"確認してください",allowEdit:o.allowEdit??n.allowEdit??!0},{success:!0,output:t.input,pendingReview:!0}):{success:!0,output:t.input}}},llm:n,azureChatOpenAI:n,chatOpenAI:n,openAI:n,openai:n,chatModel:n,chatmodel:n,gpt:n,claude:n,gemini:n,promptTemplate:o,prompt:o,prompttemplate:o,vectorstore:a,vectorStore:a,memory:{async execute(e,t,s){let o=e.data.config||{},n=o.sessionId||s.sessionId,a=`memory_${n}`,u=s.memory.get(a)||[];if(t.input){u.push({role:"user",content:t.input,timestamp:new Date().toISOString()});let e=o.windowSize||10;for(;u.length>2*e;)u.shift();s.memory.set(a,u)}return s.logs.push(`[Memory] ${e.data.label}: 履歴 ${u.length} 件`),{success:!0,output:{history:u,input:t.input}}}},tool:{async execute(e,t,s){let o=e.data.config||{},n=o.toolType||"api";if(s.logs.push(`[Tool] ${e.data.label}: ${n} 実行`),"api"===n&&o.apiEndpoint)try{let e=await fetch(o.apiEndpoint,{method:o.method||"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t.input)}),s=await e.json();return{success:!0,output:s}}catch(t){return s.logs.push(`[Tool] ${e.data.label}: API呼び出し失敗`),{success:!1,output:null,error:t instanceof Error?t.message:"API call failed"}}return{success:!0,output:{message:"Tool executed (mock)",input:t.input}}}},chatModels:n,flowControl:u};async function l(e,t,s,o){let n=Date.now(),a={sessionId:o||`session_${Date.now()}`,input:s,nodeOutputs:new Map,logs:[],memory:new Map};a.logs.push("=== OwliaFabrica Native Engine ==="),a.logs.push(`セッションID: ${a.sessionId}`),a.logs.push(`ノード数: ${e.length}, エッジ数: ${t.length}`);try{let s=function(e,t){let s=new Map(e.map(e=>[e.id,e])),o=new Map,n=new Map;e.forEach(e=>{o.set(e.id,0),n.set(e.id,[])}),t.forEach(e=>{let t=n.get(e.source)||[];t.push(e.target),n.set(e.source,t),o.set(e.target,(o.get(e.target)||0)+1)});let a=[];o.forEach((e,t)=>{0===e&&a.push(t)});let u=[];for(;a.length>0;){let e=a.shift(),t=s.get(e);t&&u.push(t),(n.get(e)||[]).forEach(e=>{let t=(o.get(e)||1)-1;o.set(e,t),0===t&&a.push(e)})}return u}(e,t);a.logs.push(`実行順序: ${s.map(e=>e.data.label).join(" → ")}`);let o=null;for(let e of s){let s=[e.data.type,e.type,e.data.category].filter(Boolean),l=u,i="default";for(let e of s)if(r[e]){l=r[e],i=e;break}"default"===i&&a.logs.push(`[DEBUG] ${e.data.label}: タイプ ${s.join("/")} はマッピングなし、パススルー`);let c=function(e,t,s){let o={};return t.filter(t=>t.target===e.id).forEach(e=>{let t=s.get(e.source);o[e.targetHandle||"input"]=t}),o}(e,t,a.nodeOutputs),p=await l.execute(e,c,a);if(!p.success)return a.logs.push(`[ERROR] ${e.data.label}: ${p.error}`),{success:!1,output:null,executionTime:Date.now()-n,logs:a.logs,error:p.error};if(a.nodeOutputs.set(e.id,p.output),o=p.output,p.pendingReview&&a.pendingReview)return a.logs.push(`=== 実行一時停止: 確認待ち ===`),{success:!0,output:o,executionTime:Date.now()-n,logs:a.logs,pendingReview:a.pendingReview}}return a.logs.push(`=== 実行完了 ===`),{success:!0,output:o,executionTime:Date.now()-n,logs:a.logs}}catch(e){return a.logs.push(`[FATAL ERROR] ${e instanceof Error?e.message:"Unknown error"}`),{success:!1,output:null,executionTime:Date.now()-n,logs:a.logs,error:e instanceof Error?e.message:"Unknown error"}}}async function i(e,t,s,o,n,a){let u=Date.now(),r=[`=== Review Decision: ${o} ===`];if("reject"===o)return r.push("実行が却下されました"),{success:!1,output:null,executionTime:Date.now()-u,logs:r,error:"Review rejected by user"};let l=a||new Map;return"edit"===o&&void 0!==n&&(l.set(s,n),r.push(`編集された出力を使用: ${JSON.stringify(n).slice(0,100)}...`)),r.push("後続のノード実行を継続します（未実装）"),{success:!0,output:l.get(s),executionTime:Date.now()-u,logs:r}}}};