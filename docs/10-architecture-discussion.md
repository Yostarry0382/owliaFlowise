# エージェント実行基盤の構成に関する相談事項

## 背景

MVPリリースに向けて、エージェントの実行基盤をどのように構成するか決定が必要です。
特に「Flowise API」と「MCPサーバー」の役割分担について、チームで認識を合わせたいと思います。

---

## 現状の理解

### 既存システム
- **Owlia-Portal**: AIchat画面（ChatGPTのようなUI）- リリース済み
- **Owlia-Sprite**: 常駐型ショートカットツール - リリース済み
- **OwliaFabrica**: エージェント管理・作成ツール - 今回開発

### サーバー構成
- フロントエンドサーバー（Fabrica UI）
- APIサーバー（別サーバー）
- Flowiseサーバー（別サーバー予定）

---

## 決定が必要な事項

### 1. エージェント実行基盤の構成

#### 選択肢A：Flowiseをフロー実行エンジンとして使う

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────┐
│ Portal/     │ ──▶ │ Fabrica     │ ──▶ │ Flowise     │ ──▶ │ LLM │
│ Sprite      │     │ API         │     │ API         │     │     │
└─────────────┘     └─────────────┘     └─────────────┘     └─────┘
                           │
                    エージェント情報
                    の取得・管理
```

**メリット**
- 開発工数が少ない（既製品活用）
- フロービルダーUIが成熟している
- RAG連携等の機能が揃っている

**デメリット**
- Flowiseへの依存度が高い
- カスタマイズに制限がある
- Flowiseサーバーの運用が必要

**Flowise APIとは**
- Flowiseが提供するREST API
- `POST /api/v1/prediction/{flowId}` でフローを実行
- Flowise自体がLLM呼び出し・RAG検索等を実行

---

#### 選択肢B：MCPサーバーを独自構築

```
┌─────────────┐     ┌─────────────┐     ┌─────┐
│ Portal/     │ ──▶ │ MCP         │ ──▶ │ LLM │
│ Sprite      │     │ サーバー     │     │     │
└─────────────┘     └─────────────┘     └─────┘
                           │
                    ┌──────┴──────┐
                    │ Fabrica     │
                    │ フロー定義   │
                    └─────────────┘
```

**メリット**
- 完全に自由な設計が可能
- Flowiseへの依存なし
- Portal/Spriteとの連携を最適化できる

**デメリット**
- 開発工数が大きい（実行エンジン構築）
- MCPプロトコルの実装が必要
- 自前でRAG連携等を実装

**MCPサーバーとは**
- Model Context Protocol（Anthropic提唱）の標準規格
- AIがツールや外部データにアクセスする仕組み
- Claude等のAIモデルが外部機能を呼び出すためのプロトコル

---

#### 選択肢C：ハイブリッド構成

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────┐
│ Portal/     │ ──▶ │ MCP         │ ──▶ │ Flowise     │ ──▶ │ LLM │
│ Sprite      │     │ サーバー     │     │ API         │     │     │
└─────────────┘     └─────────────┘     └─────────────┘     └─────┘
                           │
                    ┌──────┴──────┐
                    │ Fabrica     │
                    │ エージェント │
                    │ 管理        │
                    └─────────────┘
```

**メリット**
- MCPプロトコルでPortal/Spriteと標準的に連携
- Flowiseの実行エンジンを活用
- 将来的な拡張性も確保

**デメリット**
- 両方の知識が必要
- 構成がやや複雑

---

### 2. Portal/SpriteのMCP対応状況

以下を確認したいです：

- [ ] Portal/SpriteはMCPプロトコルに対応していますか？
- [ ] 対応している場合、MCPサーバーへの接続方法は？
- [ ] 対応していない場合、REST API経由での連携を想定？

---

### 3. 工数への影響

| 構成 | 追加工数目安 | 備考 |
|------|-------------|------|
| A: Flowise利用 | +2〜3人日 | Flowise API連携のみ |
| B: MCP独自構築 | +10〜15人日 | 実行エンジン構築含む |
| C: ハイブリッド | +5〜7人日 | MCPラッパー + Flowise連携 |

**現在の総工数**: 27人日（2名 × 12人日 + 15人日）

構成Bを選択した場合、MVPスコープの大幅な縮小が必要になる可能性があります。

---

## 相談したいこと

1. **Portal/SpriteからエージェントをどうやってUI呼び出す想定だったか？**
   - REST API？
   - MCPプロトコル？
   - その他？

2. **Flowiseを使う前提だったか、独自実行エンジンを想定していたか？**

3. **MCPサーバーの役割として何を期待していたか？**
   - エージェント実行のエントリーポイント？
   - ツール呼び出しの仲介？
   - その他？

4. **推奨構成はどれか？**
   - A / B / C / その他

---

## 次のステップ

上記が決まり次第、以下を進めます：

1. API仕様の確定（フロント・バックエンド分業のため）
2. 詳細な工数見積もり
3. タスク分割と担当割り当て

---

## 追加確認事項：Flowise運用について

### 現状
- 既存APIサーバー: **VMで運用中**
- Flowise運用可否: **未評価**

### Flowiseサーバー管理で必要な作業

| 項目 | 内容 |
|------|------|
| 初期構築 | Flowiseのインストール・設定・起動 |
| サーバー運用 | 常時稼働させるためのプロセス管理 |
| データ管理 | 作成したフロー・認証情報の永続化 |
| 監視 | 障害検知・ログ管理・アラート |
| 更新 | Flowiseのバージョンアップ対応 |

### 評価が必要な項目

- [ ] VMでFlowiseが動作するか（Node.js環境）
- [ ] 既存VMに同居 or 新規VM作成か
- [ ] DBはSQLite（簡易）かPostgreSQL（本格）か
- [ ] 必要なリソース（CPU/メモリ/ディスク）
- [ ] ネットワーク構成（APIサーバーからFlowiseへの通信経路）

### Flowise導入の工数目安（参考）

| 作業 | 工数目安 |
|------|----------|
| 環境調査・検証 | 0.5〜1人日 |
| VM構築・Flowiseインストール | 0.5〜1人日 |
| 初期設定・動作確認 | 0.5人日 |
| APIサーバーとの連携設定 | 0.5〜1人日 |
| **合計** | **2〜3.5人日** |

---

## 参考：用語説明

| 用語 | 説明 |
|------|------|
| Flowise | ノーコードでLLMフローを構築できるOSSツール |
| Flowise API | Flowiseが提供するREST API。作成したフローを実行できる |
| MCP | Model Context Protocol。AIが外部ツールやデータにアクセスするための標準規格 |
| MCPサーバー | MCPプロトコルに準拠したサーバー。AIからのツール呼び出しを処理 |
| RAG | Retrieval-Augmented Generation。外部知識を検索してLLMに渡す手法 |