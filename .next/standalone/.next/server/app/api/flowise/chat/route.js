(()=>{var e={};e.id=588,e.ids=[588],e.modules={10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},82356:(e,t,s)=>{"use strict";s.r(t),s.d(t,{patchFetch:()=>I,routeModule:()=>w,serverHooks:()=>m,workAsyncStorage:()=>y,workUnitAsyncStorage:()=>g});var r={};s.r(r),s.d(r,{OPTIONS:()=>f,POST:()=>p});var o=s(42706),a=s(28203),i=s(45994),n=s(39187),l=s(12714),d=s(75285);let u=process.env.FLOWISE_API_URL||"http://localhost:3000",h=process.env.FLOWISE_DEFAULT_CHATFLOW_ID||"",c=process.env.FLOWISE_API_KEY;async function p(e){try{let{message:t,sessionId:s,chatflowId:r}=await e.json();if(!t)return n.NextResponse.json({error:"Message is required"},{status:400});let o=r||h;if(!o)return n.NextResponse.json({message:"Flowise chatflow IDが設定されていません。.env.localでFLOWISE_DEFAULT_CHATFLOW_IDを設定するか、Flowiseでchatflowを作成してください。",sessionId:s||(0,d.A)(),isMockResponse:!0,hint:"http://localhost:3001 でFlowiseにアクセスし、chatflowを作成してください。"});let a=new l.$0({apiUrl:u,chatflowId:o,apiKey:c}),i=s||(0,d.A)(),p=await a.predict(o,t,{sessionId:i});return n.NextResponse.json({message:p.text||"",sessionId:i,sourceDocuments:p.sourceDocuments,chatId:p.chatId,chatMessageId:p.chatMessageId,usedTools:p.usedTools,agentReasoning:p.agentReasoning})}catch(s){console.error("Error in chat API:",s);let e=s instanceof Error?s.message:"Unknown error",t=e.includes("fetch")||e.includes("ECONNREFUSED")||e.includes("Network");return n.NextResponse.json({error:"Failed to process chat message",details:e,hint:t?`Flowise server may not be running. Check if it's available at ${u}`:"Check Flowise server logs for more details"},{status:500})}}async function f(){return new n.NextResponse(null,{status:200,headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"POST, OPTIONS","Access-Control-Allow-Headers":"Content-Type"}})}let w=new o.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/flowise/chat/route",pathname:"/api/flowise/chat",filename:"route",bundlePath:"app/api/flowise/chat/route"},resolvedPagePath:"C:\\Users\\yrk20\\OwliaFabrica2\\app\\api\\flowise\\chat\\route.ts",nextConfigOutput:"standalone",userland:r}),{workAsyncStorage:y,workUnitAsyncStorage:g,serverHooks:m}=w;function I(){return(0,i.patchFetch)({workAsyncStorage:y,workUnitAsyncStorage:g})}},96487:()=>{},78335:()=>{},12714:(e,t,s)=>{"use strict";s.d(t,{$0:()=>r,uD:()=>o});class r{constructor(e){this.baseUrl=e?.apiUrl||process.env.FLOWISE_API_URL||"http://localhost:3000",this.apiKey=e?.apiKey||process.env.FLOWISE_API_KEY||""}getHeaders(e="application/json"){let t={"Content-Type":e};return this.apiKey&&(t.Authorization=`Bearer ${this.apiKey}`),t}async request(e,t={}){let s=`${this.baseUrl}${e}`;try{let e=await fetch(s,{...t,headers:{...this.getHeaders(),...t.headers}});if(!e.ok){let t=await e.json().catch(()=>({}));throw new o(e.status,t.message||`API request failed: ${e.statusText}`,t)}return await e.json()}catch(e){if(e instanceof o)throw e;throw new o(0,`Network error: ${e instanceof Error?e.message:"Unknown error"}`,{originalError:e})}}async predict(e,t,s={}){let r={question:t};return s.sessionId&&(r.sessionId=s.sessionId),s.overrideConfig&&(r.overrideConfig=s.overrideConfig),s.history&&(r.history=s.history),s.uploads&&(r.uploads=s.uploads),s.humanInput&&(r.humanInput=s.humanInput),this.request(`/api/v1/prediction/${e}`,{method:"POST",body:JSON.stringify(r)})}async predictStream(e,t,s={},r){let a={question:t,streaming:!0};s.sessionId&&(a.sessionId=s.sessionId),s.overrideConfig&&(a.overrideConfig=s.overrideConfig),s.history&&(a.history=s.history);let i=`${this.baseUrl}/api/v1/prediction/${e}`,n=await fetch(i,{method:"POST",headers:this.getHeaders(),body:JSON.stringify(a)});if(!n.ok)throw new o(n.status,`Stream request failed: ${n.statusText}`);let l=n.body?.getReader();if(!l)throw new o(0,"Response body is not readable");let d=new TextDecoder,u="";try{for(;;){let{done:e,value:t}=await l.read();if(e)break;let s=d.decode(t,{stream:!0});u+=s,r&&r(s)}}finally{l.releaseLock()}return{text:u}}async submitHumanInput(e,t){return this.request(`/api/v1/prediction/${e}`,{method:"POST",body:JSON.stringify({humanInput:t})})}async getChatflows(){return this.request("/api/v1/chatflows",{method:"GET"})}async getChatflow(e){return this.request(`/api/v1/chatflows/${e}`,{method:"GET"})}async createChatflow(e){return this.request("/api/v1/chatflows",{method:"POST",body:JSON.stringify(e)})}async updateChatflow(e,t){return this.request(`/api/v1/chatflows/${e}`,{method:"PUT",body:JSON.stringify(t)})}async deleteChatflow(e){await this.request(`/api/v1/chatflows/${e}`,{method:"DELETE"})}async uploadFiles(e,t){let s=new FormData;e.forEach(e=>{s.append("files",e)}),t&&s.append("chatflowId",t);let r=`${this.baseUrl}/api/v1/get-upload-file`,a=await fetch(r,{method:"POST",headers:{...this.apiKey&&{Authorization:`Bearer ${this.apiKey}`}},body:s});if(!a.ok)throw new o(a.status,`File upload failed: ${a.statusText}`);let i=await a.json();return i.data||i}async healthCheck(){try{if((await fetch(`${this.baseUrl}/api/v1/ping`,{method:"GET"})).ok)return!0;return(await fetch(this.baseUrl,{method:"GET"})).ok}catch{return!1}}getConfig(){return{apiUrl:this.baseUrl,apiKey:this.apiKey,chatflowId:process.env.FLOWISE_DEFAULT_CHATFLOW_ID||""}}}class o extends Error{constructor(e,t,s){super(t),this.statusCode=e,this.details=s,this.name="FlowiseAPIError"}isNotFound(){return 404===this.statusCode}isUnauthorized(){return 401===this.statusCode}isValidationError(){return 422===this.statusCode}}new r},75285:(e,t,s)=>{"use strict";s.d(t,{A:()=>l});let r=require("node:crypto"),o={randomUUID:r.randomUUID},a=new Uint8Array(256),i=a.length,n=[];for(let e=0;e<256;++e)n.push((e+256).toString(16).slice(1));let l=function(e,t,s){return!o.randomUUID||t||e?function(e,t,s){let o=(e=e||{}).random??e.rng?.()??(i>a.length-16&&((0,r.randomFillSync)(a),i=0),a.slice(i,i+=16));if(o.length<16)throw Error("Random bytes length must be >= 16");if(o[6]=15&o[6]|64,o[8]=63&o[8]|128,t){if((s=s||0)<0||s+16>t.length)throw RangeError(`UUID byte range ${s}:${s+15} is out of buffer bounds`);for(let e=0;e<16;++e)t[s+e]=o[e];return t}return function(e,t=0){return(n[e[t+0]]+n[e[t+1]]+n[e[t+2]]+n[e[t+3]]+"-"+n[e[t+4]]+n[e[t+5]]+"-"+n[e[t+6]]+n[e[t+7]]+"-"+n[e[t+8]]+n[e[t+9]]+"-"+n[e[t+10]]+n[e[t+11]]+n[e[t+12]]+n[e[t+13]]+n[e[t+14]]+n[e[t+15]]).toLowerCase()}(o)}(e,t,s):o.randomUUID()}}};var t=require("../../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),r=t.X(0,[989,452],()=>s(82356));module.exports=r})();